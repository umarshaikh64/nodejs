{"version":3,"file":"index.js","sourceRoot":"","sources":["index.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Created by user on 2018/2/7/007.\n */\n\n// @ts-ignore\nimport { EPub, SYMBOL_RAW_DATA } from 'epub2';\nimport { fixToc } from 'epub2/lib/toc';\nimport cheerio from 'cheerio';\nimport path from 'path';\nimport fs from 'fs-iconv';\nimport { trimFilename } from 'fs-iconv';\n\nimport Promise from 'bluebird';\nimport novelInfo from 'node-novel-info';\nimport { fixHtml2 } from './lib/html';\n\nimport { fixText } from '@node-novel/epub-util/lib/extract/text';\nimport { fixCheerio } from '@node-novel/epub-util/lib/extract/cheerio';\n\nexport const IDKEY = 'epub';\n\nexport interface IOptions\n{\n\toutputDir?: string,\n\tcwd?: string,\n\n\t/**\n\t * print log message\n\t */\n\tlog?: boolean,\n\n\tnoFirePrefix?: boolean,\n\n\t/**\n\t * 用來強制解決某些目錄錯亂 或者 無法處理多層目錄的問題\n\t */\n\tnoVolume?: boolean,\n}\n\nexport function epubExtract(srcFile: string, options: IOptions = {}): Promise<string>\n{\n\tlet cwd = options.cwd || process.cwd();\n\n\t//srcFile = srcFile.replace(/\\u202A/g, '');\n\n\t//console.log(srcFile.charCodeAt(0));\n\t//console.log(path.isAbsolute(srcFile));\n\n\tif (!path.isAbsolute(srcFile))\n\t{\n\t\tsrcFile = path.join(cwd, srcFile);\n\t}\n\n\t{\n\t\tlet exists = fs.pathExistsSync(srcFile);\n\n\t\tif (!exists)\n\t\t{\n\t\t\tthrow new Error(`file doesn't exist. \"${srcFile}\"`);\n\t\t}\n\t}\n\n\tif (!options.outputDir)\n\t{\n\t\toptions.outputDir = path.join(cwd, IDKEY)\n\t}\n\telse if (!path.isAbsolute(options.outputDir))\n\t{\n\t\toptions.outputDir = path.join(cwd, options.outputDir);\n\t}\n\n\tconst PATH_NOVEL_MAIN = options.outputDir;\n\n\t// @ts-ignore\n\treturn EPub.createAsync(srcFile)\n\t\t.then(async function (epub)\n\t\t{\n\t\t\t// 強制修正無對應的 toc\n\t\t\tawait fixToc(epub);\n\n\t\t\tif (!epub.metadata.title)\n\t\t\t{\n\t\t\t\tepub.metadata.title = path.basename(srcFile, path.extname(srcFile))\n\t\t\t}\n\n\t\t\tlet path_novel = path.join(PATH_NOVEL_MAIN,\n\t\t\t\tfixText(trimFilename(epub.metadata.title))\n\t\t\t);\n\n\t\t\tlet currentVolume;\n\t\t\tlet volume_list = [];\n\n\t\t\tlet lastLevel = 0;\n\n\t\t\tawait Promise.mapSeries(epub.toc, async function (elem, index)\n\t\t\t{\n\t\t\t\tlet doc;\n\t\t\t\tlet $;\n\n\t\t\t\tlet isVolume: boolean;\n\t\t\t\tlet skip: boolean;\n\n\t\t\t\tif ((epub.metadata.subject || []).includes('epub-maker2'))\n\t\t\t\t{\n\t\t\t\t\tif (/^\\d+$|^volume\\d+/.test(elem.id) && !elem.level)\n\t\t\t\t\t{\n\t\t\t\t\t\tisVolume = true;\n\t\t\t\t\t}\n\t\t\t\t\telse if (/^\\d+|^chapter\\d+/.test(elem.id))\n\t\t\t\t\t{\n\t\t\t\t\t\tisVolume = false;\n\t\t\t\t\t}\n\t\t\t\t\telse if (/^image\\d+/.test(elem.id))\n\t\t\t\t\t{\n\t\t\t\t\t\tisVolume = false;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tskip = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse if (epub.ncx_depth >= 0)\n\t\t\t\t{\n\t\t\t\t\tif (!elem.level)\n\t\t\t\t\t{\n\t\t\t\t\t\tisVolume = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tlet volume_index = index;\n\t\t\t\tlet chapter_index = index;\n\n\t\t\t\tif (!skip)\n\t\t\t\t{\n\t\t\t\t\tif (options.noVolume)\n\t\t\t\t\t{\n\t\t\t\t\t\tisVolume = false;\n\t\t\t\t\t}\n\t\t\t\t\telse if (!isVolume && lastLevel != elem.level)\n\t\t\t\t\t{\n\t\t\t\t\t\t// 強制產生目錄\n\t\t\t\t\t\tdoc = await epub.getChapterAsync(elem.id);\n\t\t\t\t\t\t$ = getCheerio(doc = fixHtml2(doc));\n\n\t\t\t\t\t\tlet volume_title: string;\n\n\t\t\t\t\t\tlet a = $('section header h2').eq(0);\n\n\t\t\t\t\t\tif (!a.length)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ta = $('h2, h3, h1').eq(0);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (!a.length && !elem.title)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlet doc = await epub.getChapterRawAsync(elem.id);\n\t\t\t\t\t\t\tlet $ = getCheerio(doc);\n\t\t\t\t\t\t\ta = $('title').eq(0);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvolume_title = (a.text() || elem.title).replace(/^\\s+|\\s+$/g, '');\n\n\t\t\t\t\t\tvolume_title = fixText(volume_title);\n\n\t\t\t\t\t\tcurrentVolume = volume_list[volume_list.length] = {\n\t\t\t\t\t\t\tlevel: elem.level,\n\t\t\t\t\t\t\tvolume_index: volume_index,\n\t\t\t\t\t\t\tvolume_title: volume_title || 'null',\n\t\t\t\t\t\t\tchapter_list: [],\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tlastLevel = elem.level;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (isVolume)\n\t\t\t\t\t{\n\t\t\t\t\t\tdoc = await epub.getChapterAsync(elem.id);\n\t\t\t\t\t\t$ = getCheerio(doc = fixHtml2(doc));\n\n\t\t\t\t\t\tlet a = $('section header h2').eq(0);\n\n\t\t\t\t\t\tif (!a.length)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ta = $('h2, h3, h1').eq(0);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (!a.length && !elem.title)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlet doc = await epub.getChapterRawAsync(elem.id);\n\t\t\t\t\t\t\tlet $ = getCheerio(doc);\n\n\t\t\t\t\t\t\ta = $('title').eq(0);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet volume_title = (a.text() || elem.title).replace(/^\\s+|\\s+$/g, '');\n\n\t\t\t\t\t\tvolume_title = fixText(volume_title);\n\n\t\t\t\t\t\tcurrentVolume = volume_list[volume_list.length] = {\n\t\t\t\t\t\t\tlevel: elem.level,\n\t\t\t\t\t\t\tvolume_index: volume_index,\n\t\t\t\t\t\t\tvolume_title,\n\t\t\t\t\t\t\tchapter_list: [],\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tdoc = await epub.getChapterAsync(elem.id);\n\t\t\t\t\t\t$ = getCheerio(doc = fixHtml2(doc));\n\n\t\t\t\t\t\tlet chapter_title: string;\n\n\t\t\t\t\t\tlet a = $('section header h2').eq(0);\n\n\t\t\t\t\t\tif (!a.length)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ta = $('h2, h3, h1').eq(0);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (!a.length && !elem.title)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlet doc = await epub.getChapterRawAsync(elem.id);\n\t\t\t\t\t\t\tlet $ = getCheerio(doc = fixHtml2(doc));\n\n\t\t\t\t\t\t\ta = $('title').eq(0);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tchapter_title = (a.text() || elem.title).replace(/^\\s+|\\s+$/g, '');\n\n\t\t\t\t\t\tchapter_title = fixText(chapter_title);\n\n\t\t\t\t\t\ta = $('section article').eq(0);\n\n\t\t\t\t\t\tif (!a.length)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ta = $.root();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\ta.html((function (old)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlet html = fixHtml2(old);\n\n\t\t\t\t\t\t\thtml = html.replace(/(\\/p>)(?=[^\\n]*?<p)/ig, '$1\\n');\n\n\t\t\t\t\t\t\treturn html;\n\t\t\t\t\t\t})(a.html()));\n\n\t\t\t\t\t\tlet chapter_article = a.text().replace(/^[\\r\\n]+|[\\r\\n\\s]+$/g, '');\n\n\t\t\t\t\t\tif (!currentVolume)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcurrentVolume = volume_list[volume_list.length] = {\n\t\t\t\t\t\t\t\tlevel: Math.max(0, elem.level - 1),\n\t\t\t\t\t\t\t\tvolume_index: volume_index,\n\t\t\t\t\t\t\t\tvolume_title: 'null',\n\t\t\t\t\t\t\t\tchapter_list: [],\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tchapter_article = fixText(chapter_article);\n\n\t\t\t\t\t\tif (chapter_article.indexOf(chapter_title) == 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tchapter_article = chapter_article\n\t\t\t\t\t\t\t\t.slice(chapter_title.length)\n\t\t\t\t\t\t\t\t.replace(/^[\\r\\n]+|[\\r\\n\\s]+$/g, '')\n\t\t\t\t\t\t\t;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tcurrentVolume\n\t\t\t\t\t\t\t.chapter_list\n\t\t\t\t\t\t\t.push({\n\t\t\t\t\t\t\t\tlevel: elem.level,\n\t\t\t\t\t\t\t\tchapter_index: chapter_index,\n\t\t\t\t\t\t\t\tchapter_title,\n\t\t\t\t\t\t\t\tchapter_article,\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tlet novel = {\n\t\t\t\tnovel_title: epub.metadata.title,\n\t\t\t\tnovel_author: epub.metadata.creator,\n\n\t\t\t\tnovel_desc: epub.metadata.description,\n\t\t\t\tnovel_date: epub.metadata.date,\n\t\t\t\tnovel_publisher: epub.metadata.publisher,\n\n\t\t\t\tvolume_list,\n\n\t\t\t\ttags: epub.metadata.subject,\n\n\t\t\t\tcontribute: epub.metadata.contribute,\n\t\t\t};\n\n\t\t\tawait Promise.mapSeries(volume_list,async function (volume)\n\t\t\t{\n\t\t\t\tlet vid = volume.volume_index.toString().padStart(4, '0') + '0';\n\n\t\t\t\tlet dirname = path.join(path_novel,\n\t\t\t\t\t`${vid} ${trimFilename(volume.volume_title)}`\n\t\t\t\t\t)\n\t\t\t\t;\n\n\t\t\t\treturn Promise.mapSeries(volume.chapter_list, async function (chapter)\n\t\t\t\t{\n\t\t\t\t\tlet ext = '.txt';\n\n\t\t\t\t\t// @ts-ignore\n\t\t\t\t\tlet name = trimFilename(chapter.chapter_title);\n\n\t\t\t\t\tif (!options.noFirePrefix)\n\t\t\t\t\t{\n\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\tlet cid = chapter.chapter_index.toString().padStart(4, '0') + '0';\n\n\t\t\t\t\t\tname = `${cid}_${name}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet file = path.join(dirname,\n\n\t\t\t\t\t\t`${name}${ext}`\n\t\t\t\t\t);\n\n\t\t\t\t\t// @ts-ignore\n\t\t\t\t\tlet text = chapter.chapter_article;\n\n\t\t\t\t\tawait fs.outputFile(file, text);\n\n\t\t\t\t\tif (options.log)\n\t\t\t\t\t{\n\t\t\t\t\t\tconsole.log(file);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn file;\n\t\t\t\t});\n\t\t\t});\n\n\t\t\t{\n\t\t\t\tlet epubMaker2 = false;\n\t\t\t\tlet nodeNovel = false;\n\n\t\t\t\tepubMaker2 = (epub.metadata.subject || []).includes('epub-maker2');\n\t\t\t\tnodeNovel = (epub.metadata.subject || []).includes('node-novel');\n\n\t\t\t\tlet options = {};\n\t\t\t\toptions[IDKEY] = {\n\t\t\t\t\t'epub-maker2': epubMaker2,\n\t\t\t\t\t'node-novel': nodeNovel,\n\t\t\t\t};\n\n\t\t\t\tlet md = novelInfo.stringify({\n\t\t\t\t\toptions,\n\t\t\t\t}, novel, {\n\t\t\t\t\ttags: [\n\t\t\t\t\t\tIDKEY,\n\t\t\t\t\t\t\"epub-extract\",\n\t\t\t\t\t\t\"node-novel\",\n\t\t\t\t\t],\n\n\t\t\t\t\toptions: {\n\t\t\t\t\t\ttextlayout: {\n\t\t\t\t\t\t\tallow_lf2: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t});\n\n\t\t\t\tlet file = path.join(path_novel, `README.md`);\n\t\t\t\tawait fs.outputFile(file, md);\n\t\t\t}\n\n\t\t\treturn path_novel;\n\t\t})\n\t\t;\n}\n\nexport function getCheerio(doc: string)\n{\n\tlet $ = cheerio.load(fixHtml2(doc));\n\n\tfixCheerio('body', $);\n\n\treturn $\n}\n\nexport { fixText }\n\nexport default epubExtract;\n"]}